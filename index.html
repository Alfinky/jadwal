<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jadwal Mesin & Jam</title>

    <!-- html2canvas CDN -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --radius: 18px;
            --shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
        }

        body[data-theme="dark"] {
            --bg1: #0f172a;
            --bg2: #111827;
            --card: rgba(255, 255, 255, 0.08);
            --stroke: rgba(255, 255, 255, 0.14);
            --text: rgba(255, 255, 255, 0.92);
            --muted: rgba(255, 255, 255, 0.65);

            --btnRed1: #d32f2f;
            --btnRed2: #b71c1c;
            --btnGreen1: #43a047;
            --btnGreen2: #1b5e20;
            --btnGray1: #94a3b8;
            --btnGray2: #475569;
        }

        body[data-theme="light"] {
            --bg1: #f6f7fb;
            --bg2: #eef2ff;
            --card: rgba(255, 255, 255, 0.86);
            --stroke: rgba(15, 23, 42, 0.10);
            --text: rgba(15, 23, 42, 0.92);
            --muted: rgba(15, 23, 42, 0.60);

            --btnRed1: #ef4444;
            --btnRed2: #b91c1c;
            --btnGreen1: #22c55e;
            --btnGreen2: #15803d;
            --btnGray1: #9ca3af;
            --btnGray2: #6b7280;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: "Plus Jakarta Sans", system-ui, -apple-system, Segoe UI, Roboto, Arial;
            margin: 0;
            min-height: 100vh;
            padding: 28px 16px;
            color: var(--text);

            background:
                radial-gradient(1200px 600px at 5% 10%, rgba(239, 68, 68, 0.20), transparent 50%),
                radial-gradient(900px 500px at 90% 15%, rgba(34, 197, 94, 0.18), transparent 50%),
                radial-gradient(900px 800px at 50% 100%, rgba(59, 130, 246, 0.18), transparent 55%),
                linear-gradient(135deg, var(--bg1), var(--bg2));

            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .app {
            width: 100%;
            max-width: 1200px;
            display: grid;
            gap: 16px;
        }

        .topbar {
            padding: 16px 18px;
            border: 1px solid var(--stroke);
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            backdrop-filter: blur(12px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 46px;
            height: 46px;
            border-radius: 14px;
            overflow: hidden;
            /* biar gambar ikut rounded */
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.25);
        }

        .logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* biar pas */
            display: block;
        }


        .brand h1 {
            font-size: 18px;
            margin: 0;
            font-weight: 950;
        }

        .brand p {
            margin: 0;
            color: var(--muted);
            font-size: 13px;
            font-weight: 700;
        }

        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .panel {
            border: 1px solid var(--stroke);
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            backdrop-filter: blur(12px);
            padding: 18px;
        }

        .panel-title {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .panel-title h2 {
            margin: 0;
            font-size: 16px;
            font-weight: 950;
        }

        .hint {
            color: var(--muted);
            font-size: 12px;
            font-weight: 700;
        }

        .form {
            display: grid;
            gap: 14px;
            grid-template-columns: 1.2fr 0.6fr 0.6fr auto;
            align-items: end;
        }

        @media (max-width: 960px) {
            .form {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 520px) {
            .form {
                grid-template-columns: 1fr;
            }
        }

        .field label {
            display: block;
            font-size: 13px;
            font-weight: 900;
            color: var(--muted);
            margin-bottom: 6px;
        }

        .field input,
        .field select {
            width: 100%;
            padding: 12px 14px;
            border-radius: 14px;
            border: 1px solid var(--stroke);
            background: rgba(255, 255, 255, 0.09);
            color: var(--text);
            font-size: 14px;
            font-weight: 800;
            outline: none;
            transition: 0.2s ease;
        }

        body[data-theme="light"] .field input,
        body[data-theme="light"] .field select {
            background: rgba(255, 255, 255, 0.92);
        }

        /* ======================================================
       FIX: DROPDOWN OPTION TEXT NOT VISIBLE
       ====================================================== */
        .field select {
            color: var(--text);
        }

        .field select option {
            background: #ffffff;
            color: #111111;
        }

        body[data-theme="dark"] .field select option {
            background: #0f172a;
            color: #ffffff;
        }

        .btn {
            border: none;
            cursor: pointer;
            border-radius: 14px;
            padding: 12px 14px;
            font-weight: 950;
            letter-spacing: .2px;
            color: white;
            transition: 0.25s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            user-select: none;
            white-space: nowrap;
        }

        .btn-outline {
            background: transparent;
            color: var(--text);
            border: 1px solid var(--stroke);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--btnRed1), var(--btnRed2));
        }

        .btn-green {
            background: linear-gradient(135deg, var(--btnGreen1), var(--btnGreen2));
        }

        .btn-gray {
            background: linear-gradient(135deg, var(--btnGray1), var(--btnGray2));
        }

        .table-wrap {
            overflow-x: auto;
            border-radius: 16px;
        }

        table {
            width: 100%;
            min-width: 680px;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 16px;
            border: 1px solid var(--stroke);
            overflow: hidden;
            background: rgba(255, 255, 255, 0.07);
        }

        body[data-theme="light"] table {
            background: rgba(255, 255, 255, 0.92);
        }

        thead th {
            position: sticky;
            top: 0;
            z-index: 2;
            padding: 14px;
            font-size: 13px;
            font-weight: 950;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            text-align: center;
            color: rgba(255, 255, 255, 0.92);
            background: rgba(15, 23, 42, 0.90);
            border-bottom: 1px solid rgba(255, 255, 255, 0.12);
        }

        tbody td {
            padding: 12px;
            vertical-align: top;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.10);
            border-right: 1px solid rgba(255, 255, 255, 0.06);
            min-height: 90px;
        }

        body[data-theme="light"] tbody td {
            border-bottom: 1px solid rgba(15, 23, 42, 0.08);
            border-right: 1px solid rgba(15, 23, 42, 0.06);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        tbody td:last-child {
            border-right: none;
        }

        .col-machine {
            text-align: left !important;
            font-weight: 950;
            white-space: nowrap;
        }

        .slot {
            min-height: 85px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
            padding: 4px 0;
        }

        .slot.dragover {
            outline: 3px dashed rgba(239, 68, 68, 0.65);
            outline-offset: 6px;
            border-radius: 16px;
        }

        .badge {
            width: 100%;
            max-width: 240px;
            padding: 10px 12px;
            border-radius: 14px;
            font-size: 14px;
            font-weight: 900;
            word-break: break-word;
            text-align: center;
            cursor: pointer;
            user-select: none;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.14);
        }

        body[data-theme="light"] .badge {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.06), rgba(15, 23, 42, 0.03));
            border: 1px solid rgba(15, 23, 42, 0.10);
        }

        .loading {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(2, 6, 23, 0.78);
            backdrop-filter: blur(10px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 12px;
            text-align: center;
            padding: 18px;
        }

        .spin {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: 6px solid rgba(255, 255, 255, 0.2);
            border-top-color: rgba(255, 255, 255, 0.92);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            padding: 14px 18px;
            border-radius: 14px;
            font-weight: 950;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.95), rgba(21, 128, 61, 0.95));
            border: 1px solid rgba(255, 255, 255, 0.18);
            color: white;
            transform: translateY(-10px);
            opacity: 0;
            animation: toastIn 0.3s ease forwards;
            max-width: min(360px, 90vw);
        }

        @keyframes toastIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(2, 6, 23, 0.65);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal-card {
            width: 100%;
            max-width: 520px;
            border-radius: 18px;
            border: 1px solid var(--stroke);
            background: var(--card);
            box-shadow: var(--shadow);
            backdrop-filter: blur(14px);
            padding: 16px;
            color: var(--text);
        }

        .modal-title {
            font-size: 16px;
            font-weight: 950;
            margin: 0 0 4px;
        }

        .modal-sub {
            margin: 0 0 14px;
            color: var(--muted);
            font-size: 13px;
            font-weight: 700;
        }

        .modal-grid {
            display: grid;
            gap: 12px;
            grid-template-columns: 1fr 1fr;
        }

        @media (max-width: 520px) {
            .modal-grid {
                grid-template-columns: 1fr;
            }
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 14px;
            flex-wrap: wrap;
        }

        /* ===============================
   EXPORT AREA (TABEL HASIL EXPORT TERANG)
   =============================== */
        .export-area {
            position: fixed;
            left: -99999px;
            top: 0;
            width: 210mm;
            padding: 20mm;
            background: #ffffff;
            color: #111;
            font-family: "Plus Jakarta Sans", Arial, sans-serif;
        }

        .export-area h1 {
            margin: 0 0 18px;
            text-align: center;
            color: #d32f2f;
            font-size: 28px;
            font-weight: 950;
            letter-spacing: 1px;
            text-decoration: underline;
            text-decoration-color: #d32f2f;
            text-decoration-thickness: 3px;
        }

        /* tabel export lebih terang + modern */
        .export-area table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 16px;
            overflow: hidden;

            background: #ffffff;
            border: 1px solid #d1d5db;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
        }

        /* header tabel export */
        .export-area th {
            background: #f3f4f6;
            /* TERANG */
            color: #111827;
            font-weight: 950;
            text-transform: uppercase;
            letter-spacing: .6px;
            padding: 14px;
            border-bottom: 2px solid #d1d5db;
        }

        /* isi tabel export */
        .export-area td {
            background: #ffffff;
            color: #111827;
            padding: 14px;
            border-bottom: 1px solid #e5e7eb;
            border-right: 1px solid #e5e7eb;
            vertical-align: top;
            text-align: center;
            font-size: 14px;
        }

        /* warna selang seling */
        .export-area tbody tr:nth-child(even) td {
            background: #f9fafb;
        }

        .export-area tr:last-child td {
            border-bottom: none;
        }

        .export-area td:last-child {
            border-right: none;
        }

        /* badge nama export */
        .export-area .badge {
            width: fit-content;
            /* badge ngikut panjang teks */
            max-width: 220px;
            /* batas maksimal */
            padding: 8px 14px;
            border-radius: 14px;
            margin: 6px auto;
            font-weight: 900;
            text-align: center;

            white-space: nowrap;
            /* jangan turun baris */
            overflow: hidden;
            text-overflow: ellipsis;
            /* kalau kepanjangan jadi ... */
        }
    </style>
</head>

<body data-theme="dark">
    <div class="app">

        <div class="topbar">
            <div class="brand">
                <div class="logo">
                    <img src="logo.png" alt="QC Logo">
                </div>
                <div>
                    <h1>JADWAL ISTIRAHAT QC</h1>
                    <p>pt.dinar makmur cikarang</p>
                </div>
            </div>

            <div class="actions">
                <button id="themeBtn" class="btn btn-outline">üåó Tema</button>
                <button id="exportBtn" class="btn btn-green">üì∏ Export JPG</button>
                <button id="resetBtn" class="btn btn-gray">üßπ Reset</button>
            </div>
        </div>

        <!-- FORM -->
        <div class="panel">
            <div class="panel-title">
                <h2>Tambah Personel</h2>
            </div>

            <div class="form">
                <div class="field">
                    <label for="personName">Nama Orang</label>
                    <input type="text" id="personName" placeholder="Misal: Budi Santoso" />
                </div>

                <div class="field">
                    <label for="machineSlot">Mesin</label>
                    <select id="machineSlot">
                        <option value="3-9">3-9</option>
                        <option value="10-18">10-18</option>
                        <option value="DK">DK</option>
                        <option value="DB">DB</option>
                    </select>
                </div>

                <div class="field">
                    <label for="jamSlot">Jam</label>
                    <select id="jamSlot">
                        <option value="10">Jam 10</option>
                        <option value="11">Jam 11</option>
                        <option value="6">Jam 6</option>
                        <option value="7">Jam 7</option>
                        <option value="1">Jam 1</option>
                        <option value="3">Jam 3</option>
                    </select>
                </div>

                <button id="addPersonBtn" class="btn btn-primary">‚ûï Tambahkan</button>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:14px;">
                <div class="field">
                    <label for="modeJam">Mode Jam (kolom)</label>
                    <select id="modeJam">
                        <option value="10-11">Jam 10 - 11</option>
                        <option value="6-7">Jam 6 - 7</option>
                        <option value="1-3">Jam 1 - 3</option>
                    </select>
                </div>

                <div class="field">
                    <label for="sortToggle">Auto Sort Nama A-Z</label>
                    <select id="sortToggle">
                        <option value="on">ON</option>
                        <option value="off">OFF</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- TABLE -->
        <div class="panel">
            <div class="panel-title">
                <h2>Jadwal</h2>
            </div>

            <div class="table-wrap">
                <table id="scheduleTable"></table>
            </div>
        </div>

    </div>

    <div class="loading" id="loading">
        <div class="spin"></div>
        <div style="font-weight:950; font-size:16px;">Sedang mengekspor...</div>
        <div style="color:rgba(255,255,255,0.65); font-weight:800;">Harap tunggu sebentar</div>
    </div>

    <div class="export-area" id="exportArea"></div>

    <div class="modal" id="modal">
        <div class="modal-card">
            <p class="modal-title">Kelola Nama</p>
            <p class="modal-sub" id="modalInfo">-</p>

            <div class="modal-grid">
                <div class="field">
                    <label>Edit Nama</label>
                    <input id="editName" />
                </div>

                <div class="field">
                    <label>Pindah Jam</label>
                    <select id="moveJam">
                        <option value="10">Jam 10</option>
                        <option value="11">Jam 11</option>
                        <option value="6">Jam 6</option>
                        <option value="7">Jam 7</option>
                        <option value="1">Jam 1</option>
                        <option value="3">Jam 3</option>
                    </select>
                </div>
            </div>

            <div class="modal-actions">
                <button id="deleteBtn" class="btn btn-primary"
                    style="background:linear-gradient(135deg,#ef4444,#991b1b);">
                    üóëÔ∏è Hapus
                </button>
                <button id="closeModalBtn" class="btn btn-gray">Tutup</button>
                <button id="saveModalBtn" class="btn btn-green">Simpan</button>
            </div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = "jadwal_modejam_v1";

        const MACHINES = ["3-9", "10-18", "DK", "DB"];
        const ALL_JAMS = ["10", "11", "6", "7", "1", "3"];

        const MODE_MAP = {
            "10-11": ["10", "11"],
            "6-7": ["6", "7"],
            "1-3": ["1", "3"]
        };

        let settings = { sort: "on", theme: "dark", modeJam: "10-11" };
        let scheduleData = {};
        let selected = null;

        // Elements
        const personNameInput = document.getElementById("personName");
        const machineSlotSelect = document.getElementById("machineSlot");
        const jamSlotSelect = document.getElementById("jamSlot");
        const addPersonBtn = document.getElementById("addPersonBtn");
        const exportBtn = document.getElementById("exportBtn");
        const resetBtn = document.getElementById("resetBtn");
        const themeBtn = document.getElementById("themeBtn");
        const scheduleTable = document.getElementById("scheduleTable");
        const loadingDiv = document.getElementById("loading");
        const exportArea = document.getElementById("exportArea");

        const sortToggle = document.getElementById("sortToggle");
        const modeJamSelect = document.getElementById("modeJam");

        // Modal
        const modal = document.getElementById("modal");
        const modalInfo = document.getElementById("modalInfo");
        const editNameInput = document.getElementById("editName");
        const moveJamSelect = document.getElementById("moveJam");
        const deleteBtn = document.getElementById("deleteBtn");
        const closeModalBtn = document.getElementById("closeModalBtn");
        const saveModalBtn = document.getElementById("saveModalBtn");

        function toast(message) {
            const t = document.createElement("div");
            t.className = "toast";
            t.textContent = message;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 2300);
        }

        function initSchedule() {
            scheduleData = {};
            MACHINES.forEach(m => {
                scheduleData[m] = {};
                ALL_JAMS.forEach(j => scheduleData[m][j] = []);
            });
        }

        function saveToStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify({ settings, scheduleData }));
        }

        function loadFromStorage() {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return false;
            try {
                const payload = JSON.parse(raw);
                settings = payload.settings || settings;
                scheduleData = payload.scheduleData || scheduleData;
                return true;
            } catch {
                return false;
            }
        }

        function applySettingsUI() {
            document.body.setAttribute("data-theme", settings.theme);
            sortToggle.value = settings.sort;
            modeJamSelect.value = settings.modeJam;
        }

        function sortIfEnabled(arr) {
            if (settings.sort === "on") arr.sort((a, b) => a.localeCompare(b, "id"));
        }

        function getActiveJams() {
            return MODE_MAP[settings.modeJam] || ["10", "11"];
        }

        function renderTable() {
            const activeJams = getActiveJams();

            const thead = `
        <thead>
          <tr>
            <th style="width:18%;">Mesin</th>
            ${activeJams.map(j => `<th>Jam ${j}</th>`).join("")}
          </tr>
        </thead>
      `;

            const rows = MACHINES.map(machine => {
                const cells = activeJams.map(jam => {
                    const list = scheduleData[machine][jam] || [];
                    sortIfEnabled(list);

                    return `
            <td>
              <div class="slot" data-machine="${machine}" data-jam="${jam}">
                ${list.map((name, idx) => `
                  <div class="badge" draggable="true"
                    data-name="${encodeURIComponent(name)}"
                    data-machine="${machine}"
                    data-jam="${jam}"
                    data-index="${idx}">
                    ${name}
                  </div>
                `).join("")}
              </div>
            </td>
          `;
                }).join("");

                return `<tr><td class="col-machine">${machine}</td>${cells}</tr>`;
            }).join("");

            scheduleTable.innerHTML = thead + `<tbody>${rows}</tbody>`;
            attachSlotListeners();
            attachBadgeListeners();
        }

        function attachSlotListeners() {
            document.querySelectorAll(".slot").forEach(slot => {
                slot.addEventListener("dragover", e => {
                    e.preventDefault();
                    slot.classList.add("dragover");
                });
                slot.addEventListener("dragleave", () => slot.classList.remove("dragover"));
                slot.addEventListener("drop", e => {
                    e.preventDefault();
                    slot.classList.remove("dragover");

                    const from = JSON.parse(e.dataTransfer.getData("text/plain"));
                    const toMachine = slot.dataset.machine;
                    const toJam = slot.dataset.jam;

                    movePerson(from.machine, from.jam, from.index, toMachine, toJam);
                });
            });
        }

        function attachBadgeListeners() {
            document.querySelectorAll(".badge").forEach(badge => {
                badge.addEventListener("click", () => {
                    const name = decodeURIComponent(badge.dataset.name);
                    const machine = badge.dataset.machine;
                    const jam = badge.dataset.jam;
                    const index = Number(badge.dataset.index);

                    selected = { name, machine, jam, index };
                    openModal();
                });

                badge.addEventListener("dragstart", e => {
                    e.dataTransfer.setData("text/plain", JSON.stringify({
                        machine: badge.dataset.machine,
                        jam: badge.dataset.jam,
                        index: Number(badge.dataset.index)
                    }));
                });
            });
        }

        function addPerson(name, machine, jam) {
            scheduleData[machine][jam].push(name);
            saveToStorage();
            renderTable();
        }

        function deletePerson(machine, jam, index) {
            scheduleData[machine][jam].splice(index, 1);
            saveToStorage();
            renderTable();
        }

        function movePerson(fromMachine, fromJam, fromIndex, toMachine, toJam) {
            const name = scheduleData[fromMachine][fromJam][fromIndex];
            if (!name) return;

            scheduleData[fromMachine][fromJam].splice(fromIndex, 1);
            scheduleData[toMachine][toJam].push(name);

            saveToStorage();
            renderTable();
            toast(`üîÅ ${name} dipindah ke ${toMachine} (Jam ${toJam})`);
        }

        function openModal() {
            if (!selected) return;
            modal.style.display = "flex";
            modalInfo.textContent = `Nama: ${selected.name} ‚Ä¢ Mesin: ${selected.machine} ‚Ä¢ Jam: ${selected.jam}`;
            editNameInput.value = selected.name;
            moveJamSelect.value = selected.jam;
        }

        function closeModal() {
            modal.style.display = "none";
            selected = null;
        }

        closeModalBtn.addEventListener("click", closeModal);
        modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });

        deleteBtn.addEventListener("click", () => {
            if (!selected) return;
            if (!confirm(`Hapus "${selected.name}"?`)) return;
            deletePerson(selected.machine, selected.jam, selected.index);
            toast(`üóëÔ∏è ${selected.name} dihapus`);
            closeModal();
        });

        saveModalBtn.addEventListener("click", () => {
            if (!selected) return;

            const newName = editNameInput.value.trim();
            const newJam = moveJamSelect.value;

            if (!newName) return alert("Nama tidak boleh kosong");

            if (selected.jam === newJam) {
                scheduleData[selected.machine][selected.jam][selected.index] = newName;
            } else {
                scheduleData[selected.machine][selected.jam].splice(selected.index, 1);
                scheduleData[selected.machine][newJam].push(newName);
            }

            saveToStorage();
            renderTable();
            toast("‚úÖ Data diperbarui");
            closeModal();
        });

        addPersonBtn.addEventListener("click", () => {
            const name = personNameInput.value.trim();
            const machine = machineSlotSelect.value;
            const jam = jamSlotSelect.value;
            if (!name) return alert("Masukkan nama dulu!");
            addPerson(name, machine, jam);
            personNameInput.value = "";
            toast(`‚úÖ ${name} masuk ${machine} (Jam ${jam})`);
        });

        personNameInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") addPersonBtn.click();
        });

        sortToggle.addEventListener("change", () => {
            settings.sort = sortToggle.value;
            saveToStorage();
            renderTable();
        });

        modeJamSelect.addEventListener("change", () => {
            settings.modeJam = modeJamSelect.value;
            saveToStorage();
            renderTable();
            toast(`üìå Mode: Jam ${MODE_MAP[settings.modeJam].join("-")}`);
        });

        themeBtn.addEventListener("click", () => {
            settings.theme = settings.theme === "dark" ? "light" : "dark";
            document.body.setAttribute("data-theme", settings.theme);
            saveToStorage();
            toast(`üåó Tema: ${settings.theme.toUpperCase()}`);
        });

        resetBtn.addEventListener("click", () => {
            if (!confirm("Reset semua data jadwal?")) return;
            localStorage.removeItem(STORAGE_KEY);
            settings = { sort: "on", theme: "dark", modeJam: "10-11" };
            initSchedule();
            applySettingsUI();
            renderTable();
            toast("üßπ Jadwal berhasil direset");
        });

        exportBtn.addEventListener("click", async () => {
            loadingDiv.style.display = "flex";
            const activeJams = getActiveJams();

            exportArea.innerHTML = `
        <h1>JADWAL ISTIRAHAT</h1>
        <table>
          <thead>
            <tr>
              <th style="width:18%;">Mesin</th>
              ${activeJams.map(j => `<th>Jam ${j}</th>`).join("")}
            </tr>
          </thead>
          <tbody>
            ${MACHINES.map(machine => `
              <tr>
                <td style="font-weight:950; text-align:left;">${machine}</td>
                ${activeJams.map(jam => `
                  <td>
                    ${(scheduleData[machine][jam] || []).map(n => `<div class="badge">${n}</div>`).join("") || "-"}
                  </td>
                `).join("")}
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;

            try {
                const canvas = await html2canvas(exportArea, {
                    scale: 3,
                    backgroundColor: "#ffffff",
                    useCORS: true
                });

                const dataUrl = canvas.toDataURL("image/jpeg", 0.95);
                const link = document.createElement("a");
                link.href = dataUrl;
                link.download = "jadwal_istirahat.jpg";
                link.click();
                toast("üì∏ Export berhasil!");
            } catch (e) {
                console.error(e);
                alert("Export gagal. Coba lagi ya.");
            } finally {
                loadingDiv.style.display = "none";
            }
        });

        (function init() {
            const loaded = loadFromStorage();
            if (!loaded) initSchedule();
            applySettingsUI();
            renderTable();
        })();
    </script>

</body>

</html>